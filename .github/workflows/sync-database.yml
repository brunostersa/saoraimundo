name: ğŸ”„ Sincronizar Base de Dados

on:
  # ExecuÃ§Ã£o automÃ¡tica a cada 30 minutos - DESABILITADO
  # schedule:
  #   - cron: '*/30 * * * *'
  
  # ExecuÃ§Ã£o manual via GitHub
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'ForÃ§ar sincronizaÃ§Ã£o completa?'
        required: false
        default: 'false'
        type: boolean

  # ExecuÃ§Ã£o quando cÃ³digo Ã© enviado para main
  push:
    branches: [ main ]

jobs:
  sync-database:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸš€ Iniciar SincronizaÃ§Ã£o
        run: |
          echo "ğŸ”„ Iniciando sincronizaÃ§Ã£o da base de dados..."
          echo "ğŸ“… Data/Hora: $(date)"
          echo "ğŸŒ Branch: ${{ github.ref_name }}"
          echo "ğŸ”§ Trigger: ${{ github.event_name }}"
      
      - name: ğŸ“Š Verificar Status Inicial
        id: check-initial
        run: |
          echo "ğŸ” Verificando status inicial da sincronizaÃ§Ã£o..."
          
          RESPONSE=$(curl -s -X POST "${{ secrets.VERCEL_URL }}/api/sync" \
            -H "Content-Type: application/json" \
            -d '{"action": "check-sync"}' \
            -w "\n%{http_code}")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n -1)
          
          echo "ğŸ“‹ Resposta HTTP: $HTTP_CODE"
          echo "ğŸ“‹ Corpo da resposta: $BODY"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Status inicial verificado com sucesso"
            echo "sync_status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Erro ao verificar status inicial"
            echo "sync_status=failed" >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸ”„ Executar SincronizaÃ§Ã£o
        id: sync-execution
        if: steps.check-initial.outputs.sync_status == 'success' || github.event.inputs.force_sync == 'true'
        run: |
          echo "ğŸ”„ Executando sincronizaÃ§Ã£o..."
          
          RESPONSE=$(curl -s -X POST "${{ secrets.VERCEL_URL }}/api/sync" \
            -H "Content-Type: application/json" \
            -d '{"action": "force-sync"}' \
            -w "\n%{http_code}")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n -1)
          
          echo "ğŸ“‹ Resposta HTTP: $HTTP_CODE"
          echo "ğŸ“‹ Corpo da resposta: $BODY"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… SincronizaÃ§Ã£o executada com sucesso"
            echo "sync_result=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Erro na sincronizaÃ§Ã£o"
            echo "sync_result=failed" >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸ” Verificar Status Final
        id: check-final
        if: steps.sync-execution.outputs.sync_result == 'success'
        run: |
          echo "ğŸ” Verificando status final..."
          
          RESPONSE=$(curl -s -X POST "${{ secrets.VERCEL_URL }}/api/sync" \
            -H "Content-Type: application/json" \
            -d '{"action": "status"}' \
            -w "\n%{http_code}")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | head -n -1)
          
          echo "ğŸ“‹ Resposta HTTP: $HTTP_CODE"
          echo "ğŸ“‹ Corpo da resposta: $BODY"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Status final verificado com sucesso"
            echo "final_check=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Erro ao verificar status final"
            echo "final_check=failed" >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸ“ Resumo da ExecuÃ§Ã£o
        run: |
          echo "ğŸ¯ Resumo da SincronizaÃ§Ã£o:"
          echo "----------------------------------------"
          echo "ğŸ“… Data/Hora: $(date)"
          echo "ğŸŒ Branch: ${{ github.ref_name }}"
          echo "ğŸ”§ Trigger: ${{ github.event_name }}"
          echo "ğŸ”„ Status Inicial: ${{ steps.check-initial.outputs.sync_status }}"
          
          if [ "${{ steps.sync-execution.outputs.sync_result }}" != "" ]; then
            echo "ğŸ”„ SincronizaÃ§Ã£o: ${{ steps.sync-execution.outputs.sync_result }}"
          fi
          
          if [ "${{ steps.check-final.outputs.final_check }}" != "" ]; then
            echo "ğŸ” VerificaÃ§Ã£o Final: ${{ steps.check-final.outputs.final_check }}"
          fi
          
          echo "----------------------------------------"
          
          if [ "${{ steps.check-final.outputs.final_check }}" = "success" ]; then
            echo "ğŸ‰ SincronizaÃ§Ã£o concluÃ­da com sucesso!"
          elif [ "${{ steps.sync-execution.outputs.sync_result }}" = "success" ]; then
            echo "âœ… SincronizaÃ§Ã£o executada, mas verificaÃ§Ã£o final falhou"
          elif [ "${{ steps.check-initial.outputs.sync_status }}" = "success" ]; then
            echo "âš ï¸ Status inicial OK, mas sincronizaÃ§Ã£o falhou"
          else
            echo "âŒ Falha na verificaÃ§Ã£o inicial"
          fi
      
      - name: ğŸš¨ Notificar Falha
        if: failure()
        run: |
          echo "âŒ SincronizaÃ§Ã£o falhou!"
          echo "ğŸ” Verifique os logs acima para mais detalhes"
          echo "ğŸ“§ Considere configurar notificaÃ§Ãµes para falhas"
